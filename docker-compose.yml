version: "3.9"
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: demo
      POSTGRES_PASSWORD: demo
      POSTGRES_DB: ecommerce
    ports: ["5432:5432"]
    volumes:
      - ./postgres/init:/docker-entrypoint-initdb.d

  redpanda:
    image: redpandadata/redpanda:v24.1.10
    command:
      - redpanda start --overprovisioned --smp 1 --memory 1G --reserve-memory 0M --check=false
    ports: ["9092:9092","9644:9644"]

  connect:
    image: quay.io/debezium/connect:2.7
    depends_on: [postgres, redpanda]
    environment:
      BOOTSTRAP_SERVERS: redpanda:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: connect_configs
      OFFSET_STORAGE_TOPIC: connect_offsets
      STATUS_STORAGE_TOPIC: connect_statuses
      KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
    ports: ["8083:8083"]

  airflow:
    image: apache/airflow:2.9.3
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: "dev"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./:/opt/airflow/repo
    command: bash -c "airflow db init && airflow users create --username admin --password admin --firstname a --lastname b --role Admin --email a@b.c && airflow webserver & airflow scheduler"
    ports: ["8080:8080"]

  console:
    image: redpandadata/console:latest
    depends_on: [redpanda]
    environment:
      KAFKA_BROKERS: redpanda:9092
    ports: ["8081:8080"]
